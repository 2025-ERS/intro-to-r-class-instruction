---
title: "Intro to dplyr ggplot and pipes"
author: "Han Olff"
date: "2025-09-02"
format: html
editor: 
  markdown: 
    wrap: 72
editor_options: 
  chunk_output_type: console
---

# Intro to dplyr ggplot and pipes

### 01 Set up the working environment

```{r message = FALSE, warning = FALSE}
# clear the R environment
rm(list = ls())
rm(list=ls()) # clear working memory
if (!requireNamespace("renv", quietly = TRUE)) {install.packages("renv")}
library(renv) # load renv library
renv::restore() # restore the packages in the renv.lock file
library(tidyverse) # load the tidyverse package

```

### 02 Introduction to the data

We will work with an online database of the Schiermonnikoog transect
study, that you will collect additional data for next week in the field.
In this example, we work with measurements of cockles (a bivalve
mollusc) on their width and length. From the database Epibenthos, we
will work with the table
[FactCockles](https://docs.google.com/spreadsheets/d/1E1vUWAHhse7fhjBf94Kiog3Rsj7IkMuFtP-BTQX2oI8/edit?gid=1538766002#gid=1538766002).
See the documentation of the different variables in the table
[MetVariables](https://docs.google.com/spreadsheets/d/1E1vUWAHhse7fhjBf94Kiog3Rsj7IkMuFtP-BTQX2oI8/edit?gid=1290622213#gid=1290622213)

### 03 Read the datafile from the Google sheets database

To read the data in R, you first need to know the published csv link of
the FactCockles table. In the database, you can find this link in the
table MetTables. It is produced in Google Sheets throught the menu
File/Share/Publish to web and then selecting the table and output as
csv.

Read the FactCockleSize table with read_csv, which reads it as tibble
(formatted dataframe)

```{r}
FactCockleSize <- readr::read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSpormjGiM4uWMTIZYm9Upt5j1Ige_Wu9CrhGGdvjXwxmHP2R6S7JDyEmiGTn3fXihl5s5yBn_sdo8h/pub?gid=1538766002&single=true&output=csv")
print(FactCockleSize)  # show the contents of the tibble
names(FactCockleSize)  # show variable names
# explore some aspects of the dataset
FactCockleSize$length_mm # show all values for length
FactCockleSize[,6] # show all values for length (column 6)
FactCockleSize |> dplyr::select(length_mm)  # this is the preferred way!
FactCockleSize[5,6] #  values for length (observation 5, column 6)
FactCockleSize |> dplyr::filter(CockleObs_ID==5) |> dplyr::select(length_mm)   # this is the preferred way!
nrow(FactCockleSize) # number of records (rows)
```

Plot with ggplot the relation between cockle thickness (thickness_mm, as
x) and length (length_mm), showing each year with a different color, and
add a regression line through all the years

```{r}
ggplot2::ggplot(data=FactCockleSize,
                mapping=aes(x=length_mm,y=thickness_mm)) +
                geom_point(size=2) +
                xlab("cockle length (mm)") +
                ylab("cockle width (mm)")

# remove extreme outliers that are likely data entry mistakes and make the plot again
FactCockleSize |>  dplyr::filter(thickness_mm>100) 

FactCockleSize2 <- FactCockleSize |>
  dplyr::filter(CockleObs_ID!=1531, CockleObs_ID!=469)  |> # remove this outlier
  dplyr::mutate(year=factor(year)) # make year a factor
FactCockleSize2

ggplot2::ggplot(data=FactCockleSize2,
                mapping=aes(x=length_mm,y=thickness_mm)) +
                geom_point(size=2) +
                xlab("cockle length (mm)") +
                ylab("cockle width (mm)")
FactCockleSize |>  dplyr::filter(thickness_mm>10, length_mm<5) 
# add also CockleObs_ID 469 to the previous  filter

```

Further explore the plot with a regression line through all the data

```{r}
ggplot2::ggplot(data=FactCockleSize2, mapping=aes(x=length_mm,y=thickness_mm)) +
                geom_point(size=2) +
                xlab("cockle length (mm)") +
                ylab("cockle thickness (mm)") +
                geom_smooth(method='lm')

# show the model coefficients
model_lm<-lm(thickness_mm~length_mm, data=FactCockleSize2)
summary(model_lm)
```

Make same plot but showing a separate regression line per year

```{r}
# color the points by year, but plot one regression line
ggplot2::ggplot(data=FactCockleSize2,
                mapping=aes(x=length_mm,y=thickness_mm)) +
  geom_point(mapping=aes(col=factor(year)), size=2) +
  xlab("cockle length(mm)") +
  ylab("cockle width (mm)") +
  geom_smooth(method='lm')
```

Make a panel plot where with each year is shown as a separate graph

```{r}
ggplot2::ggplot(data=drop_na(FactCockleSize2),  # drop rows with NA (missing values)
                mapping=aes(x=length_mm,y=thickness_mm, group=year)) +
  geom_point(size=2) +
  xlab("cockle length(mm)") +
  ylab("cockle width (mm)") +
  geom_smooth(method='lm') +
  facet_wrap(~year)
```

We conclude from this that: \* there were two important outliers in the
dataset that were removed after visual inspection \* the regression
between length and width is abou the same for every year, we safely can
use only length as a proxy for the biomass of an individual cockle
